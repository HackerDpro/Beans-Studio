<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beans Studio | Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4a00e0;
      --secondary: #00c9ff;
      --accent: #00ff9d;
      --dark: #0f0c29;
      --light: #f0f8ff;
      --admin-dark: #0a081e;
      --admin-panel: #15132e;
      --danger: #ff4d6d;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Exo 2", sans-serif;
      background: linear-gradient(135deg, var(--admin-dark) 0%, #0d0b1d 100%);
      color: var(--light);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.7;
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(0, 201, 255, 0.2);
    }

    .admin-header h1 {
      font-family: "Orbitron", sans-serif;
      font-size: 2.5rem;
      background: linear-gradient(to right, var(--secondary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .admin-nav {
      display: flex;
      gap: 15px;
    }

    .admin-nav button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--primary), var(--accent));
      color: white;
    }

    .btn-secondary {
      background: rgba(0, 201, 255, 0.1);
      color: var(--secondary);
      border: 1px solid rgba(0, 201, 255, 0.3);
    }

    .btn-danger {
      background: linear-gradient(45deg, #d0004d, var(--danger));
      color: white;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 201, 255, 0.4);
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(25, 20, 60, 0.6);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      border: 1px solid rgba(0, 201, 255, 0.2);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      border-color: var(--accent);
      box-shadow: 0 10px 25px rgba(0, 201, 255, 0.2);
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      font-family: "Orbitron", sans-serif;
    }

    .stat-label {
      color: rgba(240, 248, 255, 0.8);
      font-size: 1.1rem;
    }

    .admin-section {
      background: rgba(25, 20, 60, 0.6);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(0, 201, 255, 0.2);
      backdrop-filter: blur(10px);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .section-header h2 {
      font-size: 1.8rem;
      color: var(--accent);
      font-family: "Orbitron", sans-serif;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .admin-table th {
      background: rgba(74, 0, 224, 0.3);
      padding: 15px;
      text-align: left;
      color: var(--accent);
      font-weight: 600;
    }

    .admin-table td {
      padding: 15px;
      border-bottom: 1px solid rgba(0, 201, 255, 0.1);
    }

    .admin-table tr:hover {
      background: rgba(0, 201, 255, 0.05);
    }

    .action-btns {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }

    .action-btn.view {
      background: rgba(0, 201, 255, 0.1);
      color: var(--secondary);
    }

    .action-btn.delete {
      background: rgba(255, 77, 109, 0.1);
      color: var(--danger);
    }

    .action-btn:hover {
      transform: translateY(-2px);
    }

    .newsletter-form {
      display: grid;
      gap: 20px;
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 1rem;
      opacity: 0.9;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(0, 201, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
      font-size: 1rem;
    }

    .form-group textarea {
      min-height: 200px;
      resize: vertical;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.15);
    }

    .form-row {
      display: flex;
      gap: 20px;
    }

    .form-col {
      flex: 1;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 15px 25px;
      border-radius: 10px;
      background: rgba(25, 20, 60, 0.95);
      border: 1px solid var(--accent);
      color: white;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 15px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.4s ease;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--accent);
    }

    .toast.error {
      border-color: #ff4d4d;
    }

    .toast i {
      font-size: 1.5rem;
    }

    .toast.success i {
      color: var(--accent);
    }

    .toast.error i {
      color: #ff4d4d;
    }

    /* Chart container */
    .chart-container {
      height: 300px;
      margin-top: 20px;
      position: relative;
    }

    /* Loading spinner */
    .loader {
      border: 4px solid rgba(0, 201, 255, 0.3);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 992px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }

    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      
      .admin-nav {
        width: 100%;
        justify-content: center;
      }
      
      .action-btns {
        flex-direction: column;
        gap: 5px;
      }
    }

    /* Auth styles */
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(15, 12, 41, 0.6);
      padding: 8px 15px;
      border-radius: 30px;
      border: 1px solid rgba(0, 201, 255, 0.3);
      position: absolute;
      top: 20px;
      right: 20px;
    }
    
    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      overflow: hidden;
    }
    
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .logout-btn {
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 5px;
    }
    
    .logout-btn:hover {
      color: var(--secondary);
      transform: scale(1.1);
    }
    
    /* Login overlay */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 8, 30, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .login-form {
      background: rgba(25, 20, 60, 0.95);
      border-radius: 20px;
      padding: 40px;
      width: 90%;
      max-width: 400px;
      border: 2px solid var(--secondary);
      box-shadow: 0 0 50px rgba(0, 201, 255, 0.3);
      position: relative;
    }
    
    .login-form h2 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--accent);
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
    }
    
    .login-form .form-group {
      margin-bottom: 20px;
    }
    
    .login-form input {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      background: rgba(15, 12, 41, 0.7);
      border: 1px solid rgba(0, 201, 255, 0.3);
      color: var(--light);
      font-size: 1rem;
    }
    
    .login-form input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
    }
    
    .login-submit {
      width: 100%;
      padding: 15px;
      background: linear-gradient(45deg, var(--primary), var(--accent));
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .login-submit:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(74, 0, 224, 0.5);
    }
    
    .login-error {
      color: #ff4d4d;
      margin-top: 10px;
      text-align: center;
      display: none;
    }
    
    /* User Management Styles */
    .user-management {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }
    
    @media (max-width: 1200px) {
      .user-management {
        grid-template-columns: 1fr;
      }
    }
    
    .user-detail-card {
      background: rgba(25, 20, 60, 0.6);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(0, 201, 255, 0.2);
    }
    
    .user-detail-card h3 {
      color: var(--accent);
      margin-bottom: 15px;
      font-family: "Orbitron", sans-serif;
      border-bottom: 1px solid rgba(0, 201, 255, 0.3);
      padding-bottom: 10px;
    }
    
    .user-info-row {
      display: flex;
      margin-bottom: 10px;
    }
    
    .user-info-label {
      font-weight: 600;
      width: 150px;
      color: var(--secondary);
    }
    
    .user-info-value {
      flex: 1;
      word-break: break-all;
    }
    
    .user-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .user-action-btn {
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .user-action-btn.reset {
      background: rgba(0, 201, 255, 0.1);
      color: var(--secondary);
      border: 1px solid rgba(0, 201, 255, 0.3);
    }
    
    .user-action-btn.delete {
      background: rgba(255, 77, 109, 0.1);
      color: var(--danger);
      border: 1px solid rgba(255, 77, 109, 0.3);
    }
    
    .user-action-btn:hover {
      transform: translateY(-3px);
    }
    
    .password-display {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .password-text {
      font-family: monospace;
      letter-spacing: 1px;
    }
    
    .reveal-btn {
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
    }
    
    /* Modal for password reset */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 8, 30, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: rgba(25, 20, 60, 0.95);
      border-radius: 15px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      border: 2px solid var(--secondary);
      box-shadow: 0 0 50px rgba(0, 201, 255, 0.3);
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h3 {
      color: var(--accent);
      font-family: "Orbitron", sans-serif;
    }
    
    .close-modal {
      background: transparent;
      border: none;
      color: var(--light);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Loading spinner */
    .spinner {
      border: 3px solid rgba(0, 201, 255, 0.3);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div class="login-overlay" id="login-overlay">
    <div class="login-form">
      <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" placeholder="admin@beansstudio.com">
      </div>
      <div class="form-group">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" placeholder="Your password">
      </div>
      <button class="login-submit" id="login-btn">
        <i class="fas fa-sign-in-alt"></i> Sign In
      </button>
      <div class="login-error" id="login-error">
        Invalid credentials or you don't have admin privileges
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="admin-dashboard" style="display:none;">
    <div class="user-info" id="user-info">
      <div class="user-avatar">
        <i class="fas fa-user"></i>
      </div>
      <span id="user-email"></span>
      <button class="logout-btn" id="logout-btn" title="Logout">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
    
    <div class="admin-container">
      <div class="admin-header">
        <h1><i class="fas fa-user-shield"></i> BEANS STUDIO ADMIN PANEL</h1>
        <div class="admin-nav">
          <button class="btn btn-primary" id="refresh-btn">
            <i class="fas fa-sync-alt"></i> Refresh Data
          </button>
        </div>
      </div>

      <div class="admin-stats">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-value" id="subscribers-count">0</div>
          <div class="stat-label">Total Subscribers</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-user-friends"></i>
          </div>
          <div class="stat-value" id="users-count">0</div>
          <div class="stat-label">Registered Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="stat-value" id="newsletters-count">0</div>
          <div class="stat-label">Newsletters Sent</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-calendar-day"></i>
          </div>
          <div class="stat-value" id="new-subscribers">0</div>
          <div class="stat-label">New Today</div>
        </div>
      </div>

      <div class="admin-section">
        <div class="section-header">
          <h2><i class="fas fa-paper-plane"></i> Send Newsletter</h2>
        </div>
        
        <form class="newsletter-form" id="newsletter-form">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="newsletter-subject">Subject *</label>
                <input type="text" id="newsletter-subject" placeholder="Enter email subject" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="newsletter-preview">Preview Text</label>
                <input type="text" id="newsletter-preview" placeholder="Text shown in email preview">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="newsletter-content">Email Content *</label>
            <textarea id="newsletter-content" placeholder="Write your newsletter content here..." required></textarea>
          </div>
          
          <div class="form-group">
            <label for="newsletter-segment">Segment</label>
            <select id="newsletter-segment" class="form-group" style="width:100%; padding:15px; border-radius:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(0,201,255,0.3); color:var(--light);">
              <option value="all">All Subscribers</option>
              <option value="active">Active Subscribers</option>
              <option value="new">New Subscribers (Last 30 days)</option>
            </select>
          </div>
          
          <div style="display: flex; gap: 15px; margin-top: 10px;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 30px;">
              <i class="fas fa-paper-plane"></i> Send Newsletter
            </button>
            <button type="button" class="btn btn-secondary" id="save-draft">
              <i class="fas fa-save"></i> Save Draft
            </button>
          </div>
        </form>
      </div>

      <div class="admin-section">
        <div class="section-header">
          <h2><i class="fas fa-envelope"></i> Subscribers Management</h2>
          <div>
            <button class="btn btn-secondary" id="export-subscribers-btn">
              <i class="fas fa-download"></i> Export CSV
            </button>
          </div>
        </div>
        
        <div class="loader" id="subscribers-loader"></div>
        <div class="table-responsive">
          <table class="admin-table" id="subscribers-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Subscription Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="subscribers-body">
              <!-- Subscribers will be loaded here -->
            </tbody>
          </table>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
          <div style="color: rgba(240, 248, 255, 0.7);">
            Showing <span id="showing-count">0</span> of <span id="total-count">0</span> subscribers
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" id="prev-btn" disabled>
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button class="btn btn-secondary" id="next-btn" disabled>
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="admin-section">
        <div class="section-header">
          <h2><i class="fas fa-users-cog"></i> User Accounts Management</h2>
          <div>
            <input type="text" id="user-search" class="search-bar" placeholder="Search users..." style="max-width: 300px;">
          </div>
        </div>
        
        <div class="user-management">
          <div class="user-list-card">
            <div class="loader" id="users-loader"></div>
            <div class="table-responsive">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Created</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="users-body">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="user-detail-card">
            <h3>User Details</h3>
            <div id="user-details">
              <div class="user-info-row">
                <div class="user-info-label">Select a user:</div>
                <div class="user-info-value">← Choose a user from the list</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="admin-section">
        <div class="section-header">
          <h2><i class="fas fa-chart-bar"></i> Subscriber Analytics</h2>
          <div>
            <select class="btn btn-secondary" id="date-range" style="padding: 8px 15px;">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
          </div>
        </div>
        
        <div class="chart-container">
          <canvas id="analytics-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Reset Modal -->
  <div class="modal" id="password-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Reset Password</h3>
        <button class="close-modal" id="close-password-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="user-email-display">User Email</label>
          <input type="text" id="user-email-display" class="search-bar" readonly>
        </div>
        <div class="form-group">
          <label for="new-password">New Password</label>
          <input type="password" id="new-password" class="search-bar" placeholder="Enter new password">
        </div>
        <div class="form-group">
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password" class="search-bar" placeholder="Confirm new password">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-reset">Cancel</button>
        <button class="btn btn-primary" id="confirm-reset">Reset Password</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toast-message">Operation completed successfully</span>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAwuXJVVj8hXspC6eT5o6eQw6ayEoeCulo",
      authDomain: "friendly-path-408913.firebaseapp.com",
      databaseURL: "https://friendly-path-408913-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "friendly-path-408913",
      storageBucket: "friendly-path-408913.firebasestorage.app",
      messagingSenderId: "277938290410",
      appId: "1:277938290410:web:6626adb2c06d1ae96d2193",
      measurementId: "G-2N5YQHS2TF"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // DOM Elements
    const loginOverlay = document.getElementById("login-overlay");
    const adminDashboard = document.getElementById("admin-dashboard");
    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");
    const loginBtn = document.getElementById("login-btn");
    const loginError = document.getElementById("login-error");
    const logoutBtn = document.getElementById("logout-btn");
    const userInfo = document.getElementById("user-info");
    const userEmail = document.getElementById("user-email");
    
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toast-message");
    const newsletterForm = document.getElementById("newsletter-form");
    const refreshBtn = document.getElementById("refresh-btn");
    const exportSubscribersBtn = document.getElementById("export-subscribers-btn");
    const saveDraftBtn = document.getElementById("save-draft");
    const dateRange = document.getElementById("date-range");
    const subscribersBody = document.getElementById("subscribers-body");
    const subscribersLoader = document.getElementById("subscribers-loader");
    const subscribersCount = document.getElementById("subscribers-count");
    const usersCount = document.getElementById("users-count");
    const newslettersCount = document.getElementById("newsletters-count");
    const newSubscribers = document.getElementById("new-subscribers");
    const showingCount = document.getElementById("showing-count");
    const totalCount = document.getElementById("total-count");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    
    // User management elements
    const usersLoader = document.getElementById("users-loader");
    const usersBody = document.getElementById("users-body");
    const userDetails = document.getElementById("user-details");
    const userSearch = document.getElementById("user-search");
    const passwordModal = document.getElementById("password-modal");
    const closePasswordModal = document.getElementById("close-password-modal");
    const cancelReset = document.getElementById("cancel-reset");
    const confirmReset = document.getElementById("confirm-reset");
    const userEmailDisplay = document.getElementById("user-email-display");
    const newPasswordInput = document.getElementById("new-password");
    const confirmPasswordInput = document.getElementById("confirm-password");
    
    // State variables
    let selectedUser = null;
    let usersList = [];
    
    // Chart instance
    let analyticsChart = null;
    
    // Pagination variables
    const pageSize = 10;
    let currentPage = 1;
    let totalSubscribers = 0;
    let lastVisible = null;
    
    // Show toast notification
    function showToast(message, isSuccess = true) {
      toastMessage.textContent = message;
      toast.className = "toast " + (isSuccess ? "success" : "error");
      toast.classList.add("show");

      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }
    
    // Format date for display
    function formatDate(date) {
      if (!date) return "N/A";
      const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
      return new Date(date).toLocaleDateString(undefined, options);
    }
    
    // Fetch subscribers from Firestore
    async function fetchSubscribers(page = 1) {
      try {
        subscribersLoader.style.display = "block";
        subscribersBody.innerHTML = "";
        
        let query = db.collection("subscribers")
          .orderBy("subscribedAt", "desc")
          .limit(pageSize);
          
        if (page > 1 && lastVisible) {
          query = query.startAfter(lastVisible);
        }
        
        const snapshot = await query.get();
        
        // Update pagination state
        totalSubscribers = snapshot.size;
        lastVisible = snapshot.docs[snapshot.docs.length - 1];
        
        // Update counters
        showingCount.textContent = snapshot.docs.length;
        totalCount.textContent = await getTotalSubscribers();
        
        // Enable/disable pagination buttons
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = snapshot.docs.length < pageSize;
        
        // Process each subscriber
        snapshot.forEach(doc => {
          const subscriber = doc.data();
          const row = document.createElement("tr");
          
          row.innerHTML = `
            <td>${subscriber.email}</td>
            <td>${formatDate(subscriber.subscribedAt)}</td>
            <td><span style="color: var(--accent);">${subscriber.status || "active"}</span></td>
            <td class="action-btns">
              <button class="action-btn delete" data-id="${doc.id}">
                <i class="fas fa-trash"></i> Delete
              </button>
            </td>
          `;
          
          subscribersBody.appendChild(row);
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.action-btn.delete').forEach(btn => {
          btn.addEventListener('click', deleteSubscriber);
        });
        
      } catch (error) {
        showToast("Error fetching subscribers: " + error.message, false);
        console.error("Error fetching subscribers:", error);
      } finally {
        subscribersLoader.style.display = "none";
      }
    }
    
    // Get total subscriber count
    async function getTotalSubscribers() {
      try {
        const snapshot = await db.collection("subscribers").get();
        return snapshot.size;
      } catch (error) {
        console.error("Error getting subscriber count:", error);
        return 0;
      }
    }
    
    // Get new subscribers count (last 24 hours)
    async function getNewSubscribers() {
      try {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const snapshot = await db.collection("subscribers")
          .where("subscribedAt", ">", yesterday)
          .get();
        
        return snapshot.size;
      } catch (error) {
        console.error("Error getting new subscribers:", error);
        return 0;
      }
    }
    
    // Delete a subscriber
    async function deleteSubscriber(e) {
      const id = e.target.dataset.id;
      const row = e.target.closest('tr');
      const email = row.querySelector('td:first-child').textContent;
      
      if(confirm(`Are you sure you want to remove ${email} from subscribers?`)) {
        try {
          await db.collection("subscribers").doc(id).delete();
          row.style.opacity = "0.5";
          row.style.backgroundColor = "rgba(255, 77, 109, 0.1)";
          
          setTimeout(() => {
            row.remove();
            showToast("Subscriber removed successfully");
            updateStats();
          }, 800);
        } catch (error) {
          showToast("Error deleting subscriber: " + error.message, false);
          console.error("Error deleting subscriber:", error);
        }
      }
    }
    
    // Export subscribers to CSV
    async function exportSubscribers() {
      try {
        showToast("Preparing export...");
        
        const snapshot = await db.collection("subscribers").get();
        let csvContent = "data:text/csv;charset=utf-8,Email,Subscription Date,Status\n";
        
        snapshot.forEach(doc => {
          const subscriber = doc.data();
          csvContent += `${subscriber.email},${formatDate(subscriber.subscribedAt)},${subscriber.status || "active"}\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "beans_subscribers.csv");
        document.body.appendChild(link);
        
        link.click();
        document.body.removeChild(link);
        
        showToast("Export completed successfully");
      } catch (error) {
        showToast("Error exporting subscribers: " + error.message, false);
        console.error("Error exporting subscribers:", error);
      }
    }
    
    // Update stats on dashboard
    async function updateStats() {
      try {
        // Total subscribers
        const total = await getTotalSubscribers();
        subscribersCount.textContent = total;
        
        // Total users
        const usersSnapshot = await db.collection("users").get();
        usersCount.textContent = usersSnapshot.size;
        
        // Total newsletters
        const newslettersSnapshot = await db.collection("newsletters").get();
        newslettersCount.textContent = newslettersSnapshot.size;
        
        // New subscribers today
        const newToday = await getNewSubscribers();
        newSubscribers.textContent = newToday;
        
      } catch (error) {
        console.error("Error updating stats:", error);
      }
    }
    
    // Render analytics chart
    function renderChart(days = 30) {
      const ctx = document.getElementById('analytics-chart').getContext('2d');
      
      // Generate labels (last X days)
      const labels = [];
      const today = new Date();
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      }
      
      // Generate random data
      const data = {
        labels: labels,
        datasets: [{
          label: 'New Subscribers',
          data: Array.from({length: days}, () => Math.floor(Math.random() * 10) + 3),
          backgroundColor: 'rgba(0, 201, 255, 0.2)',
          borderColor: 'rgba(0, 201, 255, 1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true
        }]
      };
      
      // Destroy previous chart if exists
      if (analyticsChart) {
        analyticsChart.destroy();
      }
      
      // Create new chart
      analyticsChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(25, 20, 60, 0.9)',
              titleColor: '#00ff9d',
              bodyColor: '#f0f8ff',
              borderColor: 'rgba(0, 201, 255, 0.3)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 201, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(240, 248, 255, 0.7)'
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 201, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(240, 248, 255, 0.7)'
              }
            }
          }
        }
      });
    }
    
    // Handle newsletter form submission
    async function sendNewsletter(e) {
      e.preventDefault();
      
      const subject = document.getElementById("newsletter-subject").value;
      const content = document.getElementById("newsletter-content").value;
      const segment = document.getElementById("newsletter-segment").value;
      
      if (!subject || !content) {
        showToast("Subject and content are required", false);
        return;
      }
      
      try {
        // Show loading state
        const sendBtn = document.querySelector("#newsletter-form [type='submit']");
        const originalBtnText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        sendBtn.disabled = true;
        
        // Get subscribers based on segment
        let subscribersQuery = db.collection("subscribers");
        
        if (segment === "active") {
          // Active subscribers (subscribed in last 90 days)
          const activeDate = new Date();
          activeDate.setDate(activeDate.getDate() - 90);
          subscribersQuery = subscribersQuery.where("subscribedAt", ">", activeDate);
        } else if (segment === "new") {
          // New subscribers (last 30 days)
          const newDate = new Date();
          newDate.setDate(newDate.getDate() - 30);
          subscribersQuery = subscribersQuery.where("subscribedAt", ">", newDate);
        }
        
        const snapshot = await subscribersQuery.get();
        const count = snapshot.size;
        
        // Save newsletter to Firestore
        await db.collection("newsletters").add({
          subject,
          content,
          segment,
          sentAt: new Date(),
          recipientCount: count,
          status: "sent"
        });
        
        // Update UI
        showToast(`Newsletter "${subject}" sent to ${count} subscribers!`);
        newsletterForm.reset();
        
      } catch (error) {
        showToast("Error sending newsletter: " + error.message, false);
        console.error("Error sending newsletter:", error);
      } finally {
        // Restore button state
        const sendBtn = document.querySelector("#newsletter-form [type='submit']");
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Newsletter';
        sendBtn.disabled = false;
        updateStats();
      }
    }
    
    // USER MANAGEMENT FUNCTIONS
    
    // Fetch all users from Firestore
    async function fetchUsers() {
      try {
        usersLoader.style.display = "block";
        usersBody.innerHTML = "";
        
        const snapshot = await db.collection("users").get();
        usersList = [];
        
        snapshot.forEach(doc => {
          const userData = doc.data();
          usersList.push({
            id: doc.id,
            ...userData
          });
          
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${userData.email}</td>
            <td>${formatDate(userData.createdAt)}</td>
            <td>${userData.lastLogin ? formatDate(userData.lastLogin) : 'Never'}</td>
            <td class="action-btns">
              <button class="action-btn view" data-id="${doc.id}">
                <i class="fas fa-eye"></i> View
              </button>
            </td>
          `;
          usersBody.appendChild(row);
        });
        
        // Add event listeners to view buttons
        document.querySelectorAll('.action-btn.view').forEach(btn => {
          btn.addEventListener('click', () => viewUser(btn.dataset.id));
        });
        
      } catch (error) {
        showToast("Error fetching users: " + error.message, false);
        console.error("Error fetching users:", error);
      } finally {
        usersLoader.style.display = "none";
      }
    }
    
    // View user details
    function viewUser(userId) {
      selectedUser = usersList.find(user => user.id === userId);
      
      if (!selectedUser) return;
      
      userDetails.innerHTML = `
        <div class="user-info-row">
          <div class="user-info-label">Email:</div>
          <div class="user-info-value">${selectedUser.email}</div>
        </div>
        <div class="user-info-row">
          <div class="user-info-label">Name:</div>
          <div class="user-info-value">${selectedUser.name || 'N/A'}</div>
        </div>
        <div class="user-info-row">
          <div class="user-info-label">Account Created:</div>
          <div class="user-info-value">${formatDate(selectedUser.createdAt)}</div>
        </div>
        <div class="user-info-row">
          <div class="user-info-label">Last Login:</div>
          <div class="user-info-value">${selectedUser.lastLogin ? formatDate(selectedUser.lastLogin) : 'Never'}</div>
        </div>
        <div class="user-info-row">
          <div class="user-info-label">Role:</div>
          <div class="user-info-value">${selectedUser.role || 'user'}</div>
        </div>
        <div class="user-actions">
          <button class="user-action-btn reset" id="reset-password-btn">
            <i class="fas fa-key"></i> Reset Password
          </button>
          <button class="user-action-btn delete" id="delete-user-btn">
            <i class="fas fa-trash-alt"></i> Delete User
          </button>
        </div>
      `;
      
      // Add event listeners to action buttons
      document.getElementById("reset-password-btn")?.addEventListener("click", openPasswordResetModal);
      document.getElementById("delete-user-btn")?.addEventListener("click", deleteUser);
    }
    
    // Open password reset modal
    function openPasswordResetModal() {
      if (!selectedUser) return;
      
      userEmailDisplay.value = selectedUser.email;
      newPasswordInput.value = "";
      confirmPasswordInput.value = "";
      passwordModal.classList.add("active");
    }
    
    // Reset user password
    async function resetPassword() {
      if (!selectedUser) return;
      
      const email = selectedUser.email;
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      if (!newPassword || !confirmPassword) {
        showToast("Please enter and confirm the new password", false);
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showToast("Passwords do not match", false);
        return;
      }
      
      try {
        confirmReset.innerHTML = '<span class="spinner"></span> Resetting...';
        confirmReset.disabled = true;
        
        // This would be handled by a Firebase Cloud Function in production
        // For this demo, we'll simulate the process
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        showToast(`Password reset for ${email} was successful`);
        passwordModal.classList.remove("active");
        
      } catch (error) {
        showToast("Error resetting password: " + error.message, false);
      } finally {
        confirmReset.innerHTML = 'Reset Password';
        confirmReset.disabled = false;
      }
    }
    
    // Delete user
    async function deleteUser() {
      if (!selectedUser) return;
      
      if (!confirm(`Are you sure you want to permanently delete ${selectedUser.email}? This action cannot be undone.`)) {
        return;
      }
      
      try {
        // Delete user document from Firestore
        await db.collection("users").doc(selectedUser.id).delete();
        
        // Delete user from Authentication
        // Note: This requires a Cloud Function in a real app
        // We'll simulate it for this demo
        
        showToast(`User ${selectedUser.email} has been deleted`);
        
        // Remove from UI
        document.querySelector(`[data-id="${selectedUser.id}"]`).closest('tr').remove();
        userDetails.innerHTML = `
          <div class="user-info-row">
            <div class="user-info-label">Select a user:</div>
            <div class="user-info-value">← Choose a user from the list</div>
          </div>
        `;
        selectedUser = null;
        
        // Update stats
        updateStats();
        
      } catch (error) {
        showToast("Error deleting user: " + error.message, false);
      }
    }
    
    // Initialize the admin dashboard
    async function initDashboard() {
      // First load
      await fetchSubscribers();
      await fetchUsers();
      await updateStats();
      renderChart(30);
      
      // Set up event listeners
      refreshBtn.addEventListener('click', async () => {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
        await fetchSubscribers(currentPage);
        await fetchUsers();
        await updateStats();
        renderChart(parseInt(dateRange.value));
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
        showToast("Data refreshed successfully");
      });
      
      exportSubscribersBtn.addEventListener('click', exportSubscribers);
      
      newsletterForm.addEventListener('submit', sendNewsletter);
      
      saveDraftBtn.addEventListener('click', () => {
        const subject = document.getElementById("newsletter-subject").value;
        if (subject) {
          showToast("Draft saved successfully");
        } else {
          showToast("Please add a subject before saving", false);
        }
      });
      
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          fetchSubscribers(currentPage);
        }
      });
      
      nextBtn.addEventListener('click', () => {
        currentPage++;
        fetchSubscribers(currentPage);
      });
      
      dateRange.addEventListener('change', () => {
        renderChart(parseInt(dateRange.value));
      });
    }
    
    // Authentication functions
    function checkAuthState() {
      auth.onAuthStateChanged(user => {
        if (user && user.email === "admin@beansstudio.com") {
          // Admin user authenticated
          loginOverlay.style.display = "none";
          adminDashboard.style.display = "block";
          userEmail.textContent = user.email;
          initDashboard();
        } else {
          // Not authenticated or not admin
          loginOverlay.style.display = "flex";
          adminDashboard.style.display = "none";
        }
      });
    }
    
    // Login function
    function login() {
      const email = loginEmail.value;
      const password = loginPassword.value;
      
      if (!email || !password) {
        loginError.textContent = "Please enter both email and password";
        loginError.style.display = "block";
        return;
      }
      
      // Show loading state
      loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
      loginBtn.disabled = true;
      
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          // Check if user is admin
          if (auth.currentUser.email === "admin@beansstudio.com") {
            showToast("Welcome back, Admin!");
          } else {
            // Not admin - sign out
            auth.signOut();
            loginError.textContent = "You don't have admin privileges";
            loginError.style.display = "block";
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            loginBtn.disabled = false;
          }
        })
        .catch(error => {
          loginError.textContent = error.message;
          loginError.style.display = "block";
          loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
          loginBtn.disabled = false;
        });
    }
    
    // Logout function
    function logout() {
      auth.signOut()
        .then(() => {
          showToast("You have been logged out");
          loginOverlay.style.display = "flex";
          adminDashboard.style.display = "none";
          loginEmail.value = "";
          loginPassword.value = "";
        })
        .catch(error => {
          showToast("Logout failed: " + error.message, false);
        });
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Set up event listeners
      loginBtn.addEventListener('click', login);
      logoutBtn.addEventListener('click', logout);
      
      // Password reset modal events
      closePasswordModal.addEventListener("click", () => passwordModal.classList.remove("active"));
      cancelReset.addEventListener("click", () => passwordModal.classList.remove("active"));
      confirmReset.addEventListener("click", resetPassword);
      
      // Allow pressing Enter to login
      loginPassword.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          login();
        }
      });
      
      // User search functionality
      userSearch.addEventListener("input", () => {
        const searchTerm = userSearch.value.toLowerCase();
        const rows = usersBody.querySelectorAll("tr");
        
        rows.forEach(row => {
          const email = row.querySelector("td:first-child").textContent.toLowerCase();
          row.style.display = email.includes(searchTerm) ? "" : "none";
        });
      });
      
      // Check authentication state
      checkAuthState();
    });
  </script>
</body>
</html>